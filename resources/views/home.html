{% extends 'base.html' %}

{% block page %}Home{% endblock %}

{% block main %}
    <div class="jumbotron">
        {% if user %}
            <div class="form-group">
                <label for="channel"><i class="fa fa-list fa-1x"></i> Channel:</label>
                <select class="form-control" id="channel" onchange="update();">
                    <option selected="">Select channel</option>
                    {% for key, channel in channels %}
                        <option value="{{ channel }}">{{ channel }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="username"><i class="fa fa-search fa-1x"></i> Username:</label>
                <input type="text" class="form-control" id="username" onchange="update();" />
            </div>

            <div class="form-group">
                <label for="limit"><i class="fa fa-sort-numeric-asc fa-1x"></i> Maximum number of messages:</label>
                <input type="number" class="form-control" step="1" min="1" value="50" id="limit" onchange="update();">
            </div>


            <table class="table table-bordered hidden" id="messages">
                <thead>
                    <tr>
                        <th>Date &amp; time (UTC):</th>
                        <th>Message:</th>
                        <th>Display name:</th>
                    </tr>
                </thead>

                <tbody id="messages_body"></tbody>
            </table>
        {% else %}
            <p class="text-info">
                Please login with Twitch using the link in the top-right.
            </p>
        {% endif %}
    </div>
{% endblock %}

{% if user %}
    {% block scripts %}
        <script type="text/javascript">
            function htmlEntities(str) {
                return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            }

            function update() {
                var channel = $('#channel').val();
                var username = $('#username').val();
                var limit = parseInt($('#limit').val());
                $('#messages_body').html("");

                $.ajax({
                    url: "/api/messages",
                    headers: {
                        channel: channel,
                        user: (username || ""),
                        limit: (limit || 50)
                    },
                    dataType: "json",
                    success: function(data) {
                        $('#messages').removeClass('hidden');
                        var messages = data.messages;
                        messages.forEach(function(md) {
                            $('#messages_body').append('<tr><th>' + md.datetime + '</th><td>' + htmlEntities(md.message) + '</td><td>' + htmlEntities(md.display_name) + '</td></tr>');
                        });
                    }
                });
            }
        </script>
    {% endblock %}
{% endif %}
